<div class="container mx-auto p-6">
  <h1 class="text-3xl font-bold mb-6">{{ isEdit ? 'Edit Rail Rate' : 'Add New Rail Rate' }}</h1>

  @if (loading) {
    <div class="text-center py-8">
      <p class="text-gray-600">Loading...</p>
    </div>
  } @else {
    <!-- Error Message -->
    @if (errorMessage) {
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        {{ errorMessage }}
      </div>
    }

    <!-- Conflict Dialog -->
    @if (showConflictDialog) {
      <div class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
          <h3 class="text-lg font-medium text-gray-900 mb-4">
            Conflict Detected
          </h3>
          <p class="text-gray-700 mb-4">
            {{ conflictMessage }}
          </p>

          @if (conflictingRates.length > 0) {
            <div class="bg-gray-100 p-3 rounded mb-4 max-h-48 overflow-y-auto">
              <p class="text-sm font-semibold text-gray-700 mb-2">Existing Rate(s):</p>
              @for (rate of conflictingRates; track rate.id) {
                <div class="text-sm text-gray-600 mb-1">
                  <strong>{{ getTerminalLabel(rate.originTerminalId) }}</strong> â†’
                  <strong>{{ getTerminalLabel(rate.destinationTerminalId) }}</strong>
                  <br />
                  Cost: ${{ rate.railCost | number:'1.2-2' }} | 
                  {{ rate.effectiveDate | date:'shortDate' }} to {{ rate.endDate | date:'shortDate' }}
                </div>
              }
            </div>
          }

          <div class="flex gap-3 justify-end">
            <button
              (click)="saveWithoutOverride()"
              class="px-4 py-2 text-gray-700 border border-gray-300 rounded hover:bg-gray-50"
              [disabled]="submitting"
            >
              No, Cancel
            </button>
            <button
              (click)="saveWithOverride()"
              class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
              [disabled]="submitting"
            >
              {{ submitting ? 'Saving...' : 'Yes, Override' }}
            </button>
          </div>
        </div>
      </div>
    }

    <!-- Form -->
    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="bg-white shadow rounded p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <!-- Origin Terminal -->
        <div>
          <label for="originTerminalId" class="block text-sm font-medium text-gray-700 mb-1">
            Origin Terminal <span class="text-red-500">*</span>
          </label>
          <select
            id="originTerminalId"
            formControlName="originTerminalId"
            class="w-full border border-gray-300 rounded px-3 py-2"
          >
            <option value="" disabled>Select Origin Terminal</option>
            @for (terminal of terminals; track terminal.id) {
              <option [value]="terminal.id">{{ terminal.name }} ({{ terminal.railroad }})</option>
            }
          </select>
          @if (form.get('originTerminalId')?.invalid && form.get('originTerminalId')?.touched) {
            <p class="text-red-500 text-sm mt-1">Origin terminal is required.</p>
          }
        </div>

        <!-- Destination Terminal -->
        <div>
          <label for="destinationTerminalId" class="block text-sm font-medium text-gray-700 mb-1">
            Destination Terminal <span class="text-red-500">*</span>
          </label>
          <select
            id="destinationTerminalId"
            formControlName="destinationTerminalId"
            class="w-full border border-gray-300 rounded px-3 py-2"
            [disabled]="!form.get('originTerminalId')?.value"
          >
            <option value="" disabled>
              {{ !form.get('originTerminalId')?.value ? 'Select origin first' : 'Select Destination Terminal' }}
            </option>
            @for (terminal of filteredDestinationTerminals; track terminal.id) {
              <option [value]="terminal.id">{{ terminal.name }} ({{ terminal.railroad }})</option>
            }
          </select>
          @if (form.get('destinationTerminalId')?.invalid && form.get('destinationTerminalId')?.touched) {
            <p class="text-red-500 text-sm mt-1">Destination terminal is required.</p>
          }
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <!-- Rail Cost -->
        <div>
          <label for="railCost" class="block text-sm font-medium text-gray-700 mb-1">
            Rail Cost ($) <span class="text-red-500">*</span>
          </label>
          <input
            id="railCost"
            type="number"
            step="0.01"
            formControlName="railCost"
            class="w-full border border-gray-300 rounded px-3 py-2"
            placeholder="0.00"
          />
          @if (form.get('railCost')?.invalid && form.get('railCost')?.touched) {
            <p class="text-red-500 text-sm mt-1">Rail cost must be greater than 0.</p>
          }
        </div>

        <!-- Effective Date -->
        <div>
          <label for="effectiveDate" class="block text-sm font-medium text-gray-700 mb-1">
            Effective Date <span class="text-red-500">*</span>
          </label>
          <input
            id="effectiveDate"
            type="date"
            formControlName="effectiveDate"
            class="w-full border border-gray-300 rounded px-3 py-2"
          />
          @if (form.get('effectiveDate')?.invalid && form.get('effectiveDate')?.touched) {
            <p class="text-red-500 text-sm mt-1">Effective date is required.</p>
          }
        </div>

        <!-- End Date -->
        <div>
          <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">
            End Date <span class="text-red-500">*</span>
          </label>
          <input
            id="endDate"
            type="date"
            formControlName="endDate"
            class="w-full border border-gray-300 rounded px-3 py-2"
          />
          @if (form.get('endDate')?.invalid && form.get('endDate')?.touched) {
            <p class="text-red-500 text-sm mt-1">End date is required.</p>
          }
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <!-- Status -->
        <div>
          <label for="status" class="block text-sm font-medium text-gray-700 mb-1">
            Status <span class="text-red-500">*</span>
          </label>
          <select
            id="status"
            formControlName="status"
            class="w-full border border-gray-300 rounded px-3 py-2"
          >
            <option [value]="RailRateStatus.Active">Active</option>
            <option [value]="RailRateStatus.Inactive">Inactive</option>
          </select>
        </div>
      </div>

      <!-- Submit Buttons -->
      <div class="flex gap-3 justify-end">
        <button
          type="button"
          (click)="cancel()"
          class="px-4 py-2 text-gray-700 border border-gray-300 rounded hover:bg-gray-50"
          [disabled]="submitting"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
          [disabled]="submitting || form.invalid"
        >
          {{ submitting ? 'Saving...' : (isEdit ? 'Update Rail Rate' : 'Create Rail Rate') }}
        </button>
      </div>
    </form>
  }
</div>
