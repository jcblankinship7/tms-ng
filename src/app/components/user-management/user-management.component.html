  <!-- Tailwind Toast Notification -->
  @if (toastMessage()) {
    <div class="fixed top-6 left-1/2 z-50 transform -translate-x-1/2">
      <div class="px-6 py-3 rounded shadow-lg flex items-center gap-2"
        [class]="toastType() === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'">
        <span>{{ toastMessage() }}</span>
        <button (click)="toastMessage.set(null)" class="ml-2 text-white hover:text-gray-200 focus:outline-none">&times;</button>
      </div>
    </div>
  }
<div class="container mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold text-gray-900 mb-6">User Management</h1>

  <!-- Search Bar -->
  <div class="mb-6">
    <div class="relative">
      <input
        type="text"
        [ngModel]="searchQuery()"
        (ngModelChange)="searchQuery.set($event)"
        placeholder="Search by user, email, username, or persona..."
        class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
      />
      <svg class="absolute left-3 top-2.5 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
    </div>
  </div>

  @if (loading()) {
    <div class="text-center py-12">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
      <p class="mt-4 text-gray-600">Loading users...</p>
    </div>
  }

  @if (error()) {
    <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
      {{ error() }}
    </div>
  }

  @if (!loading() && filteredUsers().length === 0) {
    <div class="text-center py-12 bg-gray-50 rounded-lg">
      <p class="text-gray-600 text-lg">{{ searchQuery() ? 'No users match your search' : 'No users found' }}</p>
    </div>
  }

  @if (!loading() && filteredUsers().length > 0) {
    <div class="bg-white shadow-md rounded-lg overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200 user-table-min-width">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Email Confirmed
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              User
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Email
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Username
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Persona
            </th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
              Actions
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          @for (user of filteredUsers(); track user.id) {
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center gap-2">
                  <input
                    type="checkbox"
                    [checked]="user.emailConfirmed"
                    (change)="setEmailConfirmed(user.id, $any($event.target).checked)"
                    class="w-4 h-4 rounded border-gray-300"
                    title="Set email confirmed status"
                  />
                  <span class="text-sm" [class]="user.emailConfirmed ? 'text-green-600' : 'text-gray-500'">
                    {{ user.emailConfirmed ? 'Confirmed' : 'Not Confirmed' }}
                  </span>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                @if (isEditing(user.id)) {
                  <div class="flex gap-2">
                    <input title="First Name" type="text" [ngModel]="editingFirstName()" (ngModelChange)="editingFirstName.set($event)" class="px-2 py-1 border rounded w-24" placeholder="First Name" />
                    <input title="Last Name" type="text" [ngModel]="editingLastName()" (ngModelChange)="editingLastName.set($event)" class="px-2 py-1 border rounded w-24" placeholder="Last Name" />
                  </div>
                } @else {
                  <div class="text-sm font-medium text-gray-900">
                    {{ user.firstName }} {{ user.lastName }}
                  </div>
                }
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                @if (isEditing(user.id)) {
                  <input title="Email" type="email" [ngModel]="editingEmail()" (ngModelChange)="editingEmail.set($event)" class="px-2 py-1 border rounded w-44" />
                } @else {
                  {{ user.email }}
                }
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                @if (isEditing(user.id)) {
                  <input title="Username" type="text" [ngModel]="editingUserName()" (ngModelChange)="editingUserName.set($event)" class="px-2 py-1 border rounded w-36" />
                } @else {
                  {{ user.userName }}
                }
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                @if (isEditing(user.id)) {
                  <select
                    title="Editing Persona"
                    [ngModel]="editingPersona()"
                    (ngModelChange)="editingPersona.set($event)"
                    class="px-3 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                  >
                    @for (persona of personas; track persona.value) {
                      <option [value]="persona.value">{{ persona.label }}</option>
                    }
                  </select>
                } @else {
                  <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                    [class.bg-purple-100]="user.persona === UserPersonaEnum.Admin"
                    [class.text-purple-800]="user.persona === UserPersonaEnum.Admin"
                    [class.bg-green-100]="user.persona === UserPersonaEnum.Customer"
                    [class.text-green-800]="user.persona === UserPersonaEnum.Customer"
                    [class.bg-blue-100]="user.persona === UserPersonaEnum.ServiceProvider"
                    [class.text-blue-800]="user.persona === UserPersonaEnum.ServiceProvider"
                    [class.bg-yellow-100]="user.persona === UserPersonaEnum.MarketingManager"
                    [class.text-yellow-800]="user.persona === UserPersonaEnum.MarketingManager"
                    [class.bg-indigo-100]="user.persona === UserPersonaEnum.SalesRep"
                    [class.text-indigo-800]="user.persona === UserPersonaEnum.SalesRep"
                    [class.bg-pink-100]="user.persona === UserPersonaEnum.BillingClerk"
                    [class.text-pink-800]="user.persona === UserPersonaEnum.BillingClerk"
                    [class.bg-orange-100]="user.persona === UserPersonaEnum.SettlementsClerk"
                    [class.text-orange-800]="user.persona === UserPersonaEnum.SettlementsClerk">
                    {{ getPersonaLabel(user.persona) }}
                  </span>
                }
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                @if (isEditing(user.id)) {
                  <button
                    (click)="saveUser(user.id)"
                    class="text-green-600 hover:text-green-900 mr-3"
                  >
                    Save
                  </button>
                  <button
                    (click)="cancelEdit()"
                    class="text-gray-600 hover:text-gray-900 mr-3"
                  >
                    Cancel
                  </button>
                  <button
                    (click)="requestDeleteUser(user.id)"
                    class="text-red-600 hover:text-red-900"
                  >
                    Delete
                  </button>
                } @else {
                  <button
                    (click)="startEdit(user)"
                    class="text-blue-600 hover:text-blue-900 mr-3"
                  >
                    Edit
                  </button>
                  <button
                    (click)="requestDeleteUser(user.id)"
                    class="text-red-600 hover:text-red-900"
                  >
                    Delete
                  </button>
                  <!-- Custom Delete Confirmation Modal -->
                  @if (showDeleteModal()) {
                    <div class="fixed inset-0 z-50 flex items-center justify-center backdrop-blur-sm">
                      <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full border border-gray-200 overflow-visible">
                        <div class="flex items-center mb-4">
                          <svg class="w-8 h-8 text-red-500 mr-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01"/></svg>
                          <h2 class="text-xl font-semibold text-gray-900">Delete User</h2>
                        </div>
                        <p class="mb-2 text-gray-700 whitespace-normal break-words text-center">Are you sure you want to delete this user?</p>
                        <p class="mb-6 text-red-500 font-medium whitespace-normal break-words text-center">This action cannot be undone.</p>
                        <div class="flex justify-center gap-3">
                          <button (click)="cancelDeleteUser()" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-800 hover:bg-gray-200 transition">Cancel</button>
                          <button (click)="confirmDeleteUser()" class="px-4 py-2 rounded-lg bg-red-500 text-white font-semibold hover:bg-red-600 transition">Delete</button>
                        </div>
                      </div>
                    </div>
                  }
                }
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
</div>
